<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GUOFUHEE CRM">
    <link rel="apple-touch-icon" href="https://guofuhee.com.br/wp-content/uploads/2024/12/Favicon_Guofuhee.png">
    
    <title>GUOFUHEE CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-dark: #000b14; --accent-green: #00d29d; --card-bg: #001f33; --white: #ffffff; }
        
        * { -webkit-tap-highlight-color: transparent; outline: none; }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-dark); margin: 0; padding: 0; 
            color: var(--white); height: 100vh; width: 100vw; overflow: hidden; position: fixed;
        }

        /* Efeito de profundidade de App */
        .app-shell { 
            display: flex; flex-direction: column; height: 100%; width: 100%; 
            background: linear-gradient(180deg, #00111a 0%, #000b14 100%);
        }

        .header { 
            padding: 50px 20px 20px; background: rgba(0, 31, 51, 0.9);
            border-bottom: 1px solid rgba(0, 210, 157, 0.2); backdrop-filter: blur(10px);
        }

        .header h1 { font-size: 20px; font-weight: 800; margin: 0; letter-spacing: 3px; display: flex; align-items: center; gap: 10px; }
        .dot { width: 10px; height: 10px; background: var(--accent-green); border-radius: 50%; box-shadow: 0 0 10px var(--accent-green); }

        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }

        .nav-tabs { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; margin-bottom: 25px; }
        .nav-tabs button { 
            flex: 1; padding: 12px; border: none; border-radius: 10px; color: #888; 
            background: transparent; font-weight: 600; font-size: 12px; transition: 0.3s;
        }
        .nav-tabs button.active { background: var(--accent-green); color: #001f33; }

        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        label { display: block; font-size: 10px; font-weight: 700; color: var(--accent-green); text-transform: uppercase; margin: 15px 0 5px; letter-spacing: 1px; }
        
        input, select, textarea { 
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2); color: white; font-size: 16px !important; box-sizing: border-box;
        }

        .btn-submit { 
            width: 100%; padding: 20px; background: var(--accent-green); color: #001f33; 
            border: none; border-radius: 15px; font-weight: 800; font-size: 16px; margin-top: 30px;
            box-shadow: 0 10px 20px rgba(0, 210, 157, 0.2); text-transform: uppercase;
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 480px) { .grid { grid-template-columns: 1fr; } }

        #status-msg { text-align: center; margin-top: 20px; font-size: 14px; font-weight: 600; color: var(--accent-green); }
        
        /* Estilo da barra de busca */
        .search-box { background: rgba(0, 210, 157, 0.1); border: 1px solid var(--accent-green); border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; }
    </style>
</head>
<body>

<div class="app-shell">
    <div class="header">
        <h1><div class="dot"></div> GUOFUHEE CRM</h1>
    </div>

    <div class="content">
        <div class="nav-tabs">
            <button id="tab1" class="active" onclick="setMode('create')">NOVO</button>
            <button id="tab2" onclick="setMode('update')">ATUALIZAR</button>
        </div>

        <div id="searchSection" class="search-box">
            <label>Buscar OP</label>
            <input list="opData" id="searchId" placeholder="ID ou Empresa...">
            <datalist id="opData"></datalist>
            <button onclick="doSearch()" class="btn-submit" style="margin-top: 10px; padding: 12px; font-size: 12px;">LOCALIZAR</button>
        </div>

        <div class="card">
            <form id="crmForm">
                <input type="hidden" name="action" id="actionFlag" value="create">
                
                <div class="grid">
                    <div><label>ID</label><input type="text" name="id" id="f_id" readonly></div>
                    <div><label>Status</label>
                        <select name="status" id="f_status">
                            <option value="Lead">Lead</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Won">Won</option>
                            <option value="Lost">Lost</option>
                        </select>
                    </div>
                </div>

                <label>Empresa</label>
                <input type="text" name="companyName" id="f_name" required>

                <div class="grid">
                    <div><label>Owner</label><input type="text" name="owner" id="f_owner"></div>
                    <div><label>Valor (R$)</label><input type="text" name="estimatedValue" id="f_val" oninput="maskMoney(this)"></div>
                </div>

                <label>Próximo Passo</label>
                <input type="text" name="nextAction" id="f_next">

                <label>Observações</label>
                <textarea name="note" id="f_note" rows="3"></textarea>

                <button type="submit" class="btn-submit" id="mainBtn">Salvar Registro</button>
            </form>
            <div id="status-msg"></div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw7BNPehdl0IzdnOkUgEBj0Dcb97jTDxS1reJSF7QsePaC2D0n_4Vq3xK_JSOcJZ5eq/exec';

    window.onload = () => { updateId(); };

    function updateId() {
        google.script.run.withSuccessHandler(id => { document.getElementById('f_id').value = id; }).proximaOP();
    }

    function setMode(m) {
        const isUpd = m === 'update';
        document.getElementById('actionFlag').value = m;
        document.getElementById('searchSection').style.display = isUpd ? 'block' : 'none';
        document.getElementById('tab1').className = isUpd ? '' : 'active';
        document.getElementById('tab2').className = isUpd ? 'active' : '';
        if(!isUpd) { document.getElementById('crmForm').reset(); updateId(); } else {
            google.script.run.withSuccessHandler(list => {
                const dl = document.getElementById('opData');
                dl.innerHTML = "";
                list.forEach(i => { let o = document.createElement('option'); o.value = i; dl.appendChild(o); });
            }).listarOPs();
        }
    }

    function doSearch() {
        let val = document.getElementById('searchId').value;
        let id = val.split(" - ")[0];
        document.getElementById('status-msg').innerText = "Buscando...";
        google.script.run.withSuccessHandler(res => {
            if(res.found) {
                document.getElementById('f_id').value = id;
                document.getElementById('f_name').value = res.companyName;
                document.getElementById('f_owner').value = res.owner;
                document.getElementById('f_val').value = res.estimatedValue;
                document.getElementById('f_next').value = res.nextAction;
                document.getElementById('f_note').value = res.note;
                document.getElementById('status-msg').innerText = "Carregado!";
            }
        }).buscarEmpresa(id);
    }

    function maskMoney(i) {
        let v = i.value.replace(/\D/g,'');
        v = (v/100).toFixed(2).replace(".", ",");
        i.value = "R$ " + v;
    }

    document.getElementById('crmForm').addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('mainBtn').disabled = true;
        document.getElementById('status-msg').innerText = "Sincronizando com Nuvem...";
        const data = new URLSearchParams(new FormData(this));
        fetch(SCRIPT_URL, { method: 'POST', body: data, mode: 'no-cors' })
        .then(() => {
            document.getElementById('status-msg').innerText = "✅ Salvo com Sucesso!";
            document.getElementById('mainBtn').disabled = false;
            if(document.getElementById('actionFlag').value === 'create') { this.reset(); updateId(); }
        });
    });
</script>
</body>
</html>